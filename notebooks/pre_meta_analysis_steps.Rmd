---
title: "Run study/population-specific QC"
author: "Kenny Westerman"
output: html_document
---

To-do:
* Separate EasyQC template scripts for binary and quantitative

```{r setup, include=FALSE}
ws_bucket <- "gs://fc-e4b9029b-bcb4-41b6-8edc-5b37e7719bf5"

if (!require(EasyQC2)) {
  system(paste0("gsutil cp -r ", ws_bucket, "/opt ."))
  devtools::install_local("opt/EasyQC2_1.1.1.tar.gz")
}
library(EasyQC2)

library(tidyverse)
library(knitr)

system(paste0("gsutil cp -r ", ws_bucket, "/scripts ."))
```

# Overview

For a given CHARGE GLI Phase 2 project, the project team will receive a series of summary statistics files including combinations of:

* Study
* Population
* Phenotype
* Exposure definition
* Sex group (male/female/combined)

The post-GWIS pipeline then proceeds as follows (for each exposure/outcome combination):

1) Study QC (for each set of summary statistics, specific to a study/population/sex combination)
2) Pre-meta-analysis QC (generates summaries and plots across studies)
3) Population-specific meta-analysis (for each population/sex combination)
4) Cross-population meta-analysis (for each sex group, done by meta-analyzing output from Step 3)
5) Post-processing (for population-specific meta-analysis results)
6) Post-processing (for cross-population meta-analysis results)

# Study/population-specific QC

```{r prep-study-qc}
if (!file.exists("reference_files")) {
  system(paste0("gsutil cp -r ", ws_bucket, "/reference_files ."))
}

run_study_qc <- function(fn_vec, pop, output_dir) {
  ctrl_file_template_fn <- "scripts/study_qc_template.ecf"
  ctrl_file <- readLines(ctrl_file_template_fn) %>%
    str_replace("OUTPUT_DIR", output_dir) %>%
    str_replace("1000G_[A-Z]+_p3v5", paste0("1000G_", pop, "_p3v5")) %>%
    append(paste0("EASYIN --fileIn ", fn_vec), which(. == "### Input files:"))
  writeLines(ctrl_file, con = "scripts/study_qc.ecf")
  EasyQC2("scripts/study_qc.ecf")
}

studies <- paste0("STUDY", 1:2)
populations <- c("EUR", "AFR")
phenos <- "PHENO"
exposures <- "EXP"
sex_groups <- c("MALE", "FEMALE", "COMBINED")

ss_combinations_df <- expand_grid(
  study = studies,
  pop = populations,
  pheno = phenos,
  exposure = exposures,
  sex = sex_groups
) %>%
  mutate(ss_fn = paste("simulated_sumstats/PHASE2", 
                       study, pop, pheno, exposure, sex, "DATE", "txt", 
                       sep = ".")) %>%
  filter(file.exists(ss_fn))
ss_combinations_df %>%
  kable(caption = "All sets of summary stats to be processed")
```

```{r run-study-qc}
output_dir <- "easyqc2_output"

study_qc_runs_df <- ss_combinations_df %>%
  group_by(study, pop) %>%
  summarise(fn_vec = list(ss_fn), .groups = "drop")
walk2(study_qc_runs_df$fn_vec, study_qc_runs_df$pop,
      function(f, p) run_study_qc(f, p, output_dir))
```

# Pre-meta-analysis (cross-study) QC

```{r run-pre-meta-qc}
run_pre_meta_qc <- function(fn_vec, output_dir) {
  ctrl_file_template_fn <- "scripts/pre_meta_qc_template.ecf"
  ctrl_file <- readLines(ctrl_file_template_fn) %>%
    str_replace("OUTPUT_DIR", output_dir) %>%
    append(paste0("EASYIN --fileIn ", fn_vec), 
           which(. == "# EASYIN lines below (.cpaid.gz files)"))
  writeLines(ctrl_file, con = "scripts/pre_meta_qc.ecf")
  EasyQC2("scripts/pre_meta_qc.ecf")
}

pre_meta_qc_runs_df <- ss_combinations_df %>%
  mutate(easyqc_output_fn = paste0("easyqc2_output/CLEANED.",
                                   gsub(".txt", ".cpaid.gz", 
                                        basename(ss_fn)))) %>%
  group_by(pop, pheno, exposure, sex) %>%
  summarise(fn_vec = list(easyqc_output_fn), .groups = "drop")
walk(pre_meta_qc_runs_df$fn_vec, 
     function(f) run_pre_meta_qc(f, "easyqc2_output"))
```
